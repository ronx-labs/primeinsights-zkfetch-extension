var ye=Object.defineProperty;var pe=(n,r,e)=>r in n?ye(n,r,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[r]=e;var ie=(n,r,e)=>(pe(n,typeof r!="symbol"?r+"":r,e),e),te=(n,r,e)=>{if(!r.has(n))throw TypeError("Cannot "+e)};var t=(n,r,e)=>(te(n,r,"read from private field"),e?e.call(n):r.get(n)),h=(n,r,e)=>{if(r.has(n))throw TypeError("Cannot add the same private member more than once");r instanceof WeakSet?r.add(n):r.set(n,e)},v=(n,r,e,i)=>(te(n,r,"write to private field"),i?i.call(n,e):r.set(n,e),e),H=(n,r,e,i)=>({set _(c){v(n,r,c,e)},get _(){return t(n,r,i)}}),g=(n,r,e)=>(te(n,r,"access private method"),e);var oe={exports:{}};(function(n){var r=Object.prototype.hasOwnProperty,e="~";function i(){}Object.create&&(i.prototype=Object.create(null),new i().__proto__||(e=!1));function c(l,a,s){this.fn=l,this.context=a,this.once=s||!1}function b(l,a,s,u,f){if(typeof s!="function")throw new TypeError("The listener must be a function");var w=new c(s,u||l,f),m=e?e+a:a;return l._events[m]?l._events[m].fn?l._events[m]=[l._events[m],w]:l._events[m].push(w):(l._events[m]=w,l._eventsCount++),l}function d(l,a){--l._eventsCount===0?l._events=new i:delete l._events[a]}function y(){this._events=new i,this._eventsCount=0}y.prototype.eventNames=function(){var a=[],s,u;if(this._eventsCount===0)return a;for(u in s=this._events)r.call(s,u)&&a.push(e?u.slice(1):u);return Object.getOwnPropertySymbols?a.concat(Object.getOwnPropertySymbols(s)):a},y.prototype.listeners=function(a){var s=e?e+a:a,u=this._events[s];if(!u)return[];if(u.fn)return[u.fn];for(var f=0,w=u.length,m=new Array(w);f<w;f++)m[f]=u[f].fn;return m},y.prototype.listenerCount=function(a){var s=e?e+a:a,u=this._events[s];return u?u.fn?1:u.length:0},y.prototype.emit=function(a,s,u,f,w,m){var T=e?e+a:a;if(!this._events[T])return!1;var o=this._events[T],P=arguments.length,A,p;if(o.fn){switch(o.once&&this.removeListener(a,o.fn,void 0,!0),P){case 1:return o.fn.call(o.context),!0;case 2:return o.fn.call(o.context,s),!0;case 3:return o.fn.call(o.context,s,u),!0;case 4:return o.fn.call(o.context,s,u,f),!0;case 5:return o.fn.call(o.context,s,u,f,w),!0;case 6:return o.fn.call(o.context,s,u,f,w,m),!0}for(p=1,A=new Array(P-1);p<P;p++)A[p-1]=arguments[p];o.fn.apply(o.context,A)}else{var me=o.length,F;for(p=0;p<me;p++)switch(o[p].once&&this.removeListener(a,o[p].fn,void 0,!0),P){case 1:o[p].fn.call(o[p].context);break;case 2:o[p].fn.call(o[p].context,s);break;case 3:o[p].fn.call(o[p].context,s,u);break;case 4:o[p].fn.call(o[p].context,s,u,f);break;default:if(!A)for(F=1,A=new Array(P-1);F<P;F++)A[F-1]=arguments[F];o[p].fn.apply(o[p].context,A)}}return!0},y.prototype.on=function(a,s,u){return b(this,a,s,u,!1)},y.prototype.once=function(a,s,u){return b(this,a,s,u,!0)},y.prototype.removeListener=function(a,s,u,f){var w=e?e+a:a;if(!this._events[w])return this;if(!s)return d(this,w),this;var m=this._events[w];if(m.fn)m.fn===s&&(!f||m.once)&&(!u||m.context===u)&&d(this,w);else{for(var T=0,o=[],P=m.length;T<P;T++)(m[T].fn!==s||f&&!m[T].once||u&&m[T].context!==u)&&o.push(m[T]);o.length?this._events[w]=o.length===1?o[0]:o:d(this,w)}return this},y.prototype.removeAllListeners=function(a){var s;return a?(s=e?e+a:a,this._events[s]&&d(this,s)):(this._events=new i,this._eventsCount=0),this},y.prototype.off=y.prototype.removeListener,y.prototype.addListener=y.prototype.on,y.prefixed=e,y.EventEmitter=y,n.exports=y})(oe);var we=oe.exports;class ue extends Error{constructor(r){super(r),this.name="TimeoutError"}}class ge extends Error{constructor(r){super(),this.name="AbortError",this.message=r}}const se=n=>globalThis.DOMException===void 0?new ge(n):new DOMException(n),ae=n=>{const r=n.reason===void 0?se("This operation was aborted."):n.reason;return r instanceof Error?r:se(r)};function be(n,r){const{milliseconds:e,fallback:i,message:c,customTimers:b={setTimeout,clearTimeout}}=r;let d;const l=new Promise((a,s)=>{if(typeof e!="number"||Math.sign(e)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${e}\``);if(r.signal){const{signal:f}=r;f.aborted&&s(ae(f));const w=()=>{s(ae(f))};f.addEventListener("abort",w,{once:!0}),n.finally(()=>{f.removeEventListener("abort",w)})}if(e===Number.POSITIVE_INFINITY){n.then(a,s);return}const u=new ue;d=b.setTimeout.call(void 0,()=>{if(i){try{a(i())}catch(f){s(f)}return}typeof n.cancel=="function"&&n.cancel(),c===!1?a():c instanceof Error?s(c):(u.message=c??`Promise timed out after ${e} milliseconds`,s(u))},e),(async()=>{try{a(await n)}catch(f){s(f)}})()}).finally(()=>{l.clear()});return l.clear=()=>{b.clearTimeout.call(void 0,d),d=void 0},l}function Ee(n,r,e){let i=0,c=n.length;for(;c>0;){const b=Math.trunc(c/2);let d=i+b;e(n[d],r)<=0?(i=++d,c-=b+1):c=b}return i}var x;class Ie{constructor(){h(this,x,[])}enqueue(r,e){e={priority:0,...e};const i={priority:e.priority,run:r};if(this.size&&t(this,x)[this.size-1].priority>=e.priority){t(this,x).push(i);return}const c=Ee(t(this,x),i,(b,d)=>d.priority-b.priority);t(this,x).splice(c,0,i)}dequeue(){return t(this,x).shift()?.run}filter(r){return t(this,x).filter(e=>e.priority===r.priority).map(e=>e.run)}get size(){return t(this,x).length}}x=new WeakMap;var N,z,O,M,L,V,I,S,E,Y,_,q,C,Q,U,le,W,he,X,ce,Z,fe,j,de,$,G,B,re,R,ne,k,J,ee,ve,D,K;class xe extends we{constructor(e){super();h(this,U);h(this,W);h(this,X);h(this,Z);h(this,j);h(this,$);h(this,B);h(this,R);h(this,k);h(this,ee);h(this,D);h(this,N,void 0);h(this,z,void 0);h(this,O,0);h(this,M,void 0);h(this,L,void 0);h(this,V,0);h(this,I,void 0);h(this,S,void 0);h(this,E,void 0);h(this,Y,void 0);h(this,_,0);h(this,q,void 0);h(this,C,void 0);h(this,Q,void 0);ie(this,"timeout");if(e={carryoverConcurrencyCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:Ie,...e},!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${e.intervalCap?.toString()??""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${e.interval?.toString()??""}\` (${typeof e.interval})`);v(this,N,e.carryoverConcurrencyCount),v(this,z,e.intervalCap===Number.POSITIVE_INFINITY||e.interval===0),v(this,M,e.intervalCap),v(this,L,e.interval),v(this,E,new e.queueClass),v(this,Y,e.queueClass),this.concurrency=e.concurrency,this.timeout=e.timeout,v(this,Q,e.throwOnTimeout===!0),v(this,C,e.autoStart===!1)}get concurrency(){return t(this,q)}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);v(this,q,e),g(this,k,J).call(this)}async add(e,i={}){return i={timeout:this.timeout,throwOnTimeout:t(this,Q),...i},new Promise((c,b)=>{t(this,E).enqueue(async()=>{H(this,_)._++,H(this,O)._++;try{i.signal?.throwIfAborted();let d=e({signal:i.signal});i.timeout&&(d=be(Promise.resolve(d),{milliseconds:i.timeout})),i.signal&&(d=Promise.race([d,g(this,ee,ve).call(this,i.signal)]));const y=await d;c(y),this.emit("completed",y)}catch(d){if(d instanceof ue&&!i.throwOnTimeout){c();return}b(d),this.emit("error",d)}finally{g(this,X,ce).call(this)}},i),this.emit("add"),g(this,$,G).call(this)})}async addAll(e,i){return Promise.all(e.map(async c=>this.add(c,i)))}start(){return t(this,C)?(v(this,C,!1),g(this,k,J).call(this),this):this}pause(){v(this,C,!0)}clear(){v(this,E,new(t(this,Y)))}async onEmpty(){t(this,E).size!==0&&await g(this,D,K).call(this,"empty")}async onSizeLessThan(e){t(this,E).size<e||await g(this,D,K).call(this,"next",()=>t(this,E).size<e)}async onIdle(){t(this,_)===0&&t(this,E).size===0||await g(this,D,K).call(this,"idle")}get size(){return t(this,E).size}sizeBy(e){return t(this,E).filter(e).length}get pending(){return t(this,_)}get isPaused(){return t(this,C)}}N=new WeakMap,z=new WeakMap,O=new WeakMap,M=new WeakMap,L=new WeakMap,V=new WeakMap,I=new WeakMap,S=new WeakMap,E=new WeakMap,Y=new WeakMap,_=new WeakMap,q=new WeakMap,C=new WeakMap,Q=new WeakMap,U=new WeakSet,le=function(){return t(this,z)||t(this,O)<t(this,M)},W=new WeakSet,he=function(){return t(this,_)<t(this,q)},X=new WeakSet,ce=function(){H(this,_)._--,g(this,$,G).call(this),this.emit("next")},Z=new WeakSet,fe=function(){g(this,R,ne).call(this),g(this,B,re).call(this),v(this,S,void 0)},j=new WeakSet,de=function(){const e=Date.now();if(t(this,I)===void 0){const i=t(this,V)-e;if(i<0)v(this,O,t(this,N)?t(this,_):0);else return t(this,S)===void 0&&v(this,S,setTimeout(()=>{g(this,Z,fe).call(this)},i)),!0}return!1},$=new WeakSet,G=function(){if(t(this,E).size===0)return t(this,I)&&clearInterval(t(this,I)),v(this,I,void 0),this.emit("empty"),t(this,_)===0&&this.emit("idle"),!1;if(!t(this,C)){const e=!t(this,j,de);if(t(this,U,le)&&t(this,W,he)){const i=t(this,E).dequeue();return i?(this.emit("active"),i(),e&&g(this,B,re).call(this),!0):!1}}return!1},B=new WeakSet,re=function(){t(this,z)||t(this,I)!==void 0||(v(this,I,setInterval(()=>{g(this,R,ne).call(this)},t(this,L))),v(this,V,Date.now()+t(this,L)))},R=new WeakSet,ne=function(){t(this,O)===0&&t(this,_)===0&&t(this,I)&&(clearInterval(t(this,I)),v(this,I,void 0)),v(this,O,t(this,N)?t(this,_):0),g(this,k,J).call(this)},k=new WeakSet,J=function(){for(;g(this,$,G).call(this););},ee=new WeakSet,ve=async function(e){return new Promise((i,c)=>{e.addEventListener("abort",()=>{c(e.reason)},{once:!0})})},D=new WeakSet,K=async function(e,i){return new Promise(c=>{const b=()=>{i&&!i()||(this.off(e,b),c())};this.on(e,b)})};export{xe as default};
